@model ViewModelContainer<IEnumerable<PsycoApp.site.Models.CuadreCaja>>
@{
    var dynamicData = Model.DynamicData;
    ViewData["Title"] = "Cuadre de caja";
    var dHoy = DateTime.Now;
}
<link rel="stylesheet" href="~/src/css/sb-pacientes.css?ver=005" />
<link rel="stylesheet" href="~/src/css/sb-caja.css?ver=005" />

<style>
    .yourTableClass tr:nth-child(4n+1) td, .yourTableClass tr:nth-child(4n+3) td {
        background: #c5ffcf;
    }

    .sb-pa-container {
        background-color: #efefef;
    }

    .active-paginacion-tabla-modulo li:nth-of-type(odd) a {
        background-color: #f2f4f8 !important;
        color: #FFF !important;
    }
    .btn {
        padding: 7px 12px;
        font-size: 14px;
        cursor: pointer;
        display: inline-block;
        font-weight: 400;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        border: 1px solid transparent;
        padding: .5rem .75rem;
        font-size: 1rem;
        line-height: 1.25;
        border-radius: .25rem;
        transition: all .15s ease-in-out;
        width: 100%;
        color: #111217;
        background-color: #FFFFFF !important;
        border: 1px solid #111217;
    }
</style>
    <input type="hidden" id="hiddenIdSede" value="@(Model?.DynamicData?.id_sede)" />

<div class="sb-pa-container">
    <div class="sb-pa-container-buscar">
        <div class="sb-pa-container-buscar-title">
            <p class="active-titular-modulo">Cuadre de caja</p>
        </div>

        <div class="row">
            <div class="col-2">
                <label class="active-titular-modulo">Fecha:</label>
                <input id="txtFechaBusqueda" class="input100 col-12" type="date" style="background-color: #d8d9db; color: #000000; border: 1px solid rgba(0, 0, 0, .15); line-height: 1.25; vertical-align: middle;border-radius: .25rem; display: inline-block; max-width: 100%; height: calc(2.25rem + 2px); filter: invert(1);" />
            </div>
            <div class="col-2">
                <label class="active-titular-modulo">Buscar por:</label>
                <select class="input100 custom-select col-12 active-select-modulo" id="cboBuscarPor" style="padding: 0 25px 0 25px;">
                    <option value="1">Fecha exacta</option>
                    <option value="2">Año y mes</option>
                </select>
            </div>
            <div class="col-2">
                <label class="active-titular-modulo">Centro:</label>
                <select class="input100 custom-select col-12 active-select-modulo" id="cboSede" style="padding: 0 25px 0 25px;">
                    <option value="-1">Todos</option>
                    <option value="1">Sentirse bien</option>
                    <option value="2">Transforma</option>
                    <option value="3">Miraflores</option>
                </select>
            </div>
            <div class="col-2">
                <label class="active-titular-modulo">Usuario:</label>
                <select class="input100 custom-select col-12 active-select-modulo" id="cboUsuario" style="padding: 0 25px 0 25px;">
                    <option value="-1">Todos</option>
                </select>
            </div>
            <div class="col-2">
                <div class="form-group">
                    <label class="active-titular-modulo">&nbsp;</label>
                    <button type="button" class="btn btn-doc second_color" onclick="buscarPago(1, 0); verResumenUsuario(false)">
                        Buscar
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-2">
                <div class="form-group">
                    <label class="active-titular-modulo">&nbsp;</label>
                    <button type="button" class="btn btn-doc second_color" onclick="modal_efectivo_diario()">
                        Efectivo&nbsp;diario
                    </button>
                </div>
            </div>
            @* Pagos *@
            <div class="col-2">
                <div class="form-group">
                    <label class="active-titular-modulo">&nbsp;</label>
                    <button type="button" class="btn btn-doc second_color" onclick="$('#pagosModal').modal('show');">
                        Registro de&nbsp;pagos
                    </button>
                </div>
            </div>
            <div class="col-2">
                <div class="form-group">
                    <label class="active-titular-modulo">&nbsp;</label>
                    <button type="button" class="btn btn-doc second_color" onclick="aperturar_caja()">
                        Aperturar caja
                    </button>
                </div>
            </div>
            <div class="col-2">
                <div class="form-group">
                    <label class="active-titular-modulo">&nbsp;</label>
                    <button type="button" class="btn btn-doc second_color" onclick="cerrar_caja()">
                        Cerrar caja
                    </button>
                </div>
            </div>
            <div class="col-2">
                <div class="form-group">
                    <label class="active-titular-modulo">&nbsp;</label>
                    <button type="button" class="btn btn-doc second_color" onclick="mostrarModalCajas()">
                     Ver Cajas
                    </button>
                </div>
            </div>
     
        </div>

        <!-- Contenedor de la tabla -->
        <div id="containerTabla" class="sb-pa-container-table">
            @await Html.PartialAsync("~/Views/Caja/_CajaTabla.cshtml", Model.Model)
        </div>

        <div class="sb-pa-container-resume">
            <div class="sb-pa-container-resume-title">
                <p>Resumen</p>
            </div>
            <div class="sb-pa-container-resume-report">
                <div class="sb-pa-container-resume-report-item">
                    <div class="flot-chart">
                        <div class="flot-chart-content" id="reporte_nps"></div>
                    </div>

                </div>
                <div class="sb-pa-container-resume-report-item">
                    <div class="sb-pa-container-resume-report-item-table">
                        <table class="table table-hover yourTableClass active-table-modulo caja">
                            <thead>
                                <tr class="bg-success">
                                    <th class="text-center" style="width: 80px; color: #FFFFFF;">#</th>
                                    <th class="text-center" style="color: #FFFFFF;">
                                        Usuario
                                    </th>
                                    <th class="text-center" style="color: #FFFFFF;">
                                        Monto a declarar
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="bdResumen">
                            </tbody>
                        </table>
                    </div>
                    <div class="sb-pa-container-resume-report-item-table">
                        <table class="table table-hover yourTableClass active-table-modulo caja">
                            <thead>
                                <tr class="bg-success">
                                    <th class="text-center" style="width: 80px; color: #FFFFFF;">#</th>
                                    <th class="text-center" style="color: #FFFFFF;">
                                        Cantidad
                                    </th>
                                    <th class="text-center" style="color: #FFFFFF;">
                                        Forma pago
                                    </th>
                                    <th class="text-center" style="color: #FFFFFF;">
                                        Detalle pago
                                    </th>
                                    <th class="text-center" style="color: #FFFFFF;">
                                        Monto
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="bdResumen2">
                            </tbody>
                        </table>
                    </div>
                    <div class="sb-pa-container-resume-report-item-table">
                        <table class="table table-hover yourTableClass active-table-modulo caja">
                            <thead>
                                <tr class="bg-success">
                                    <th class="text-center" style="width: 80px; color: #FFFFFF;">#</th>
                                    <th class="text-center" style="color: #FFFFFF;">
                                        Fecha
                                    </th>
                                    <th class="text-center" style="color: #FFFFFF;">
                                        Importe
                                    </th>
                                    <th class="text-center" style="color: #FFFFFF;">
                                        Comentario
                                    </th>
                                    <th class="text-center" style="color: #FFFFFF;">
                                        Usuario
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="bdResumen3">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Referencia la vista parcial de pacientes dentro del modal -->

<div class="row" style="background-color: #FFF; display: none;">
    <div class="card-body">

        <div class="row">

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Resumen</h4>
                        <div class="flot-chart">
                            @* <div class="flot-chart-content" id="reporte_nps"></div> *@
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class=row>
                    <div class="col-lg-12">
                        <div class="row">
                            <div class="card" style="width: 100%;">
                                <div class="card-body">
                                    <table class="table table-hover yourTableClass">
                                        <thead>
                                            <tr class="bg-success">
                                                <th class="text-center" style="width: 80px; color: #FFFFFF;">#</th>
                                                <th class="text-center" style="color: #FFFFFF;">
                                                    Importe
                                                </th>
                                                <th class="text-center" style="color: #FFFFFF;">
                                                    Usuario
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="bdResumen">
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="card" style="width: 100%;">
                                <div class="card-body">
                                    <table class="table table-hover yourTableClass">
                                        <thead>
                                            <tr class="bg-success">
                                                <th class="text-center" style="width: 80px; color: #FFFFFF;">#</th>
                                                <th class="text-center" style="color: #FFFFFF;">
                                                    Cantidad
                                                </th>
                                                <th class="text-center" style="color: #FFFFFF;">
                                                    Monto
                                                </th>
                                                <th class="text-center" style="color: #FFFFFF;">
                                                    Forma pago
                                                </th>
                                                <th class="text-center" style="color: #FFFFFF;">
                                                    Detalle pago
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="bdResumen2">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="sb-caja-container-table">
        <table class="table table-hover yourTableClass">
            <thead>
                <tr class="bg-success">
                    <th class="text-center" style="width: 80px; color: #FFFFFF;">#</th>
                    <th class="text-center" style="color: #FFFFFF;">
                        Importe
                    </th>
                    <th class="text-center" style="color: #FFFFFF;">
                        Usuario
                    </th>
                </tr>
            </thead>
            <tbody id="bdResumen">
            </tbody>
        </table>
    </div>
</div>
<!-- MODAL -->
<div id="cajasModal" class="modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="true" style="display:none;">
    <div class="modal-dialog modal-lg" role="document" style="height: 90%; display: grid; place-items: center;">
        <div class="modal-content sb-reg-citas-popup-container">

            <!-- HEADER -->

            <div class="modal-header sb-reg-citas-popup-title">

                <h5 class="modal-title">Listado de Caja por Usuario</h5>
                <button type="button" class="close" onclick="$('#cajasModal').hide();" aria-label="Close" style="font-size: 28px; margin-top:-8px;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- BODY -->
            <div class="modal-body sb-reg-citas-popup-body">

                <!-- FILTRO -->
                <div class="sb-reg-citas-popup-tab-panel">

                    <div class="sb-reg-citas-popup-tab-panel-block">

                        <div class="sb-reg-citas-popup-tab-panel-block-item" id="divcbUsuarioCaja">
                            <span class="label-form">Usuario</span>
                            <select id="cbUsuarioCaja" class="form-control">
                                <option value="">-- Seleccione --</option>
                            </select>
                        </div>
                        <div class="sb-reg-citas-popup-tab-panel-block-item">
                            <span class="label-form">Fecha</span>
                            <input id="txtFechaCaja" class="form-control" type="date" />
                        </div>

                        <div class="sb-reg-citas-popup-tab-panel-block-item" style="margin-top:28px;">
                            <button class="btn btn-primary main_color" type="button" onclick="buscarCajaUsuario()">
                                <i class="fa fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>

                </div>

                <!-- TABLA -->
                <div class="mt-3" id="containerTablaCajas">
                    @await Html.PartialAsync(
                                      "~/Views/Caja/_CajasUsuarioTabla.cshtml",
                                      Enumerable.Empty<PsycoApp.entities.CajasUsuario>()
                                      )
                </div>

            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary sb-reg-citas-popup-button-volver"
                        onclick="$('#cajasModal').hide();">
                    Cerrar
                </button>
            </div>

        </div>
    </div>
</div>


<div id="mdl_efectivo_diario" class="modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="true">
    <div class="modal-dialog modal-md" role="document" style="height: 90%; display: grid; place-items: center;">
        <div class="modal-content sb-reg-citas-popup-container">
            <div class="modal-header sb-reg-citas-popup-title">
                <h5 class="modal-title">Efectivo diario</h5>
            </div>
            <div class="modal-body sb-reg-citas-popup-body">

                <div class="sb-reg-citas-popup-tab-panel">

                    <div class="sb-reg-citas-popup-tab-panel-block">
                        <div class="sb-reg-citas-popup-tab-panel-block-item">
                            <span class="label-form">Fecha</span>
                            <input id="txtFecha_" class="form-control" type="date" autocomplete="off" />
                        </div>
                    </div>

                    <div class="sb-reg-citas-popup-tab-panel-block">
                        <div class="sb-reg-citas-popup-tab-panel-block-item">
                            <span class="label-form">Total efectivo</span>
                            <input class="form-control" type="text" id="txtEfectivo_" autocomplete="off" onfocusout="setDecimalValue()" />
                        </div>
                    </div>

                    <div class="sb-reg-citas-popup-tab-panel-block">
                        <div class="sb-reg-citas-popup-tab-panel-block-item">
                            <span class="label-form">Observación</span>
                            <input class="form-control" type="text" id="txtComentario_" autocomplete="off" maxlength="50" />
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary sb-reg-citas-popup-button-volver" onclick="cerrar_modal_efectivo_diario()">Volver</button>
                <button type="button" class="btn btn-primary main_color sb-reg-citas-popup-button" onclick="guardar_efectivo_diario()">Aceptar</button>
            </div>
        </div>
    </div>
</div>

@Html.Partial("/Views/HistorialCitas/_PagosModal.cshtml")

<script>
    function cargarCombo(array, idCombo) {
        var html = '';
        for (var item of array) {
            html += '<option value="' + item.id + '">' + item.valor + '</option>';
        }
        $('#' + idCombo).html(html);
    }

    var anios = [
        { id: -1, valor: 'Todos' }
    ];
    let anioIni = 2022;
    let anioFin = new Date().getFullYear();

    while(anioIni <= anioFin){
        anios.push({ id: anioIni, valor: anioIni });
        anioIni++;
    }

    cargarCombo(anios, 'cboAnio');

    function fechaActualYYYYMMDD() {
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = today.getMonth() + 1; // Months start at 0!
        var dd = today.getDate();

        if (dd < 10) dd = '0' + dd;
        if (mm < 10) mm = '0' + mm;

        var formattedToday = yyyy + '-' + mm + '-' + dd;
        return formattedToday;
    }

    $('#txtFechaBusqueda, #txtFechaCaja').val(fechaActualYYYYMMDD());

    function cargar_lista_usuarios_caja() {
        var html = '';
        $.ajax({
            url: "/RegistroCitas/listar_usuarios_caja?filtrar_por_sede=1",
            type: "GET",
            async: false,
            beforeSend: function () {
                html += '<option value="-1">Todos</option>';
            },
            success: function (data) {
                for (var item of data) {
                    html += '<option value="' + item.id_usuario + '" >' + item.nombres + '</option>';
                }
            },
            error: function (response) {
                html = '<option value="-1">Todos</option>';
            },
            complete: function () {
                $('#cboUsuario').html(html);
            }
        });
    }
    cargar_lista_usuarios_caja();

    function mostrarModalCajas() {
        $('#cbUsuarioCaja').html($('#cboUsuario').html());
        $('#cajasModal').show();
    }

    var tipousuario = $('#hdnIdTipoUsuario').val();
    if (tipousuario == 3){
        $('#divcbUsuarioCaja').hide();
    }
    
    function buscarCajaUsuario() {
        const usuario = $('#cbUsuarioCaja').val();
        const fecha = $('#txtFechaCaja').val();

        if (!fecha) {
            Swal.fire({ icon: 'warning', text: 'Seleccione una fecha.' });
            return;
        }

        $.get('/Caja/ListarCajas', { fecha, usuario })
            .done(function (data) {
                $('#containerTablaCajas').html(data);
            })
            .fail(function () {
                Swal.fire({
                    icon: 'error',
                    text: 'Error al cargar el listado.'
                });
            });
    }
</script>